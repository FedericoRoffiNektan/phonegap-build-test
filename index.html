<!DOCTYPE html>
<html>
<head>
</head>
<body>
<button onclick="login()">Login</button>
<button onclick="me()">Me</button>
<!--<button onclick="getSession()">Get session</button>-->
<button onclick="getLoginStatus()">Get login</button>
<button onclick="logout()">Logout</button>
<button onclick="facebookWallPost()">facebookWallPost</button>
<button onclick="publishStoryFriend()">friendstory</button>

<div id="data">loading ...</div>

<script src="lib/jquery-1.10.2.min.js"></script>

<div id="fb-root"></div>
<!-- phonegap - cordova -->
<script src="lib/phonegap.js"></script>

<!-- cordova facebook plugin -->
<script src="lib/cdv-plugin-fb-connect.js"></script>
<!-- facebook js sdk -->
<!--<script src="lib/facebook-js-sdk.js"></script>-->


<script>
    <!-- These are the notifications that are displayed to the user through pop-ups if the above JS files does not exist in the same directory-->
    if ((typeof cordova == 'undefined') && (typeof Cordova == 'undefined')) alert('Cordova variable does not exist. Check that you have included cordova.js correctly');

    if (typeof CDV == 'undefined') alert('CDV variable does not exist. Check that you have included cdv-plugin-fb-connect.js correctly');
//    if (typeof FB == 'undefined') alert('FB variable does not exist. Check that you have included the Facebook JS SDK file.');


    var login;
    var me;
    var logout;
    var facebookWallPost;
    var publishStoryFriend;
    var getLoginStatus;

    var isDeviceReady = false;

    window.fbAsyncInit = function() {

        console.log('fbAsyncInit');

        if(isDeviceReady){
           console.log('FB INIT PHONEGAP');

            console.log('Device is ready! Make sure you set your app_id below this alert.');
            FB.init({ appId: "179088088932244", nativeInterface: CDV.FB, useCachedDialogs: false });

            document.getElementById('data').innerHTML = "facebook init phonegap";


        }else{
            console.log('FB INIT WEB');

            /* init web */
            FB.init({
                appId      : '179088088932244', // App ID
                channelUrl : '//localhost:9080/bingo/channel.html', // Channel File
                status     : true, // check login status
                cookie     : true, // enable cookies to allow the server to access the session
                xfbml      : true  // parse XFBML
            });

            document.getElementById('data').innerHTML = "facebook init web";

        }





        FB.Event.subscribe('auth.login', function(response) {
            alert('auth.login event');
        });

        FB.Event.subscribe('auth.logout', function(response) {
            alert('auth.logout event');
        });

        FB.Event.subscribe('auth.sessionChange', function(response) {
            alert('auth.sessionChange event');
        });

        FB.Event.subscribe('auth.statusChange', function(response) {
            alert('auth.statusChange event');
        });

        /*function getSession() {
         alert("session: " + JSON.stringify(FB.getSession()));
         }
         */
        getLoginStatus = function() {
            FB.getLoginStatus(function(response) {
                if (response.status == 'connected') {
                    alert('logged in');
                } else {
                    alert('not logged in');
                }
            });
        }
        var friendIDs = [];
        var fdata;
        me = function() {
            FB.api('/me/friends', { fields: 'id, name, picture' },  function(response) {
                if (response.error) {
                    alert(JSON.stringify(response.error));
                } else {
                    var data = document.getElementById('data');
                    fdata=response.data;
                    console.log("fdata: "+fdata);
                    response.data.forEach(function(item) {
                        var d = document.createElement('div');
                        d.innerHTML = "<img src=\""+item.picture.data.url+"\" />"+item.name;
                        data.appendChild(d);
                    });
                }
                var friends = response.data;
                console.log(friends.length);
                for (var k = 0; k < friends.length && k < 200; k++) {
                    var friend = friends[k];
                    var index = 1;

                    friendIDs[k] = friend.id;
                    //friendsInfo[k] = friend;
                }
                console.log("friendId's: "+friendIDs);
            });
        }

        logout = function() {
            FB.logout(function(response) {
                alert('logged out');
            });
        }

        login = function() {
            FB.login(
                    function(response) {
                        if (response.session) {
                            alert('logged in');
                        } else {
                            alert('not logged in');
                        }
                    },
                    { scope: "email" }
            );
        }


        facebookWallPost = function() {
            console.log('Debug 1');
            var params = {
                method: 'feed',
                name: 'Facebook Dialogs',
                link: 'https://developers.facebook.com/docs/reference/dialogs/',
                picture: 'http://fbrell.com/f8.jpg',
                caption: 'Reference Documentation',
                description: 'Dialogs provide a simple, consistent interface for applications to interface with users.'
            };
            console.log(params);
            FB.ui(params, function(obj) { console.log(obj);});
        }

        publishStoryFriend = function() {
            randNum = Math.floor ( Math.random() * friendIDs.length );

            var friendID = friendIDs[randNum];
            if (friendID == undefined){
                alert('please click the me button to get a list of friends first');
            }else{
                console.log("friend id: " + friendID );
                console.log('Opening a dialog for friendID: ', friendID);
                var params = {
                    method: 'feed',
                    to: friendID.toString(),
                    name: 'Facebook Dialogs',
                    link: 'https://developers.facebook.com/docs/reference/dialogs/',
                    picture: 'http://fbrell.com/f8.jpg',
                    caption: 'Reference Documentation',
                    description: 'Dialogs provide a simple, consistent interface for applications to interface with users.'
                };
                FB.ui(params, function(obj) { console.log(obj);});
            }
        }

    };

    /* DEVICEREADY */

    document.addEventListener('deviceready', function() {
        try {
            isDeviceReady = true;
        } catch (e) {
            alert(e);
        }
    }, false);

    /* SDK LOADING */

    window.setTimeout(function() {
        console.log('device is ready? '+isDeviceReady);

        if(isDeviceReady){

            console.log('FB LOAD PHONEGAP');

            $.getScript("lib/facebook-js-sdk.js", function(data, textStatus, jqxhr) {
                //console.log(data); //data returned
                console.log(textStatus); //success
                console.log(jqxhr.status); //200
                console.log('Load facebook-js-sdk.js was performed.');
            });

        }else{

            // Load the SDK asynchronously
            (function(d){
                console.log('FB LOAD WEB: Load the SDK asynchronously');

                var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
                if (d.getElementById(id)) {return;}
                js = d.createElement('script'); js.id = id; js.async = true;
                js.src = "//connect.facebook.net/en_US/all.js";
                ref.parentNode.insertBefore(js, ref);
            }(document));

        }
    }, 6000);

</script>
<div id="log"></div>
</body>
</html>
